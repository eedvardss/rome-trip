<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rome Trip Planner — Mobile Realtime</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<style>
  :root{
    --bg:#f7f9ff;--panel:#ffffff;--stroke:#e5e8f0;--text:#0f172a;--muted:#6b7280;
    --accent:#3a57a9;--accent-2:#62d3b1;--warning:#ff6a8a;
    --thu:#6aa3ff;--fri:#f6b043;--sat:#62d3b1;--sun:#ff6a8a;--hotel:#ef476f;
    --chip:#f1f5ff;--card:rgba(255,255,255,.98);--shadow:0 10px 24px rgba(15,23,42,.10);
  }
  :root[data-theme="dark"]{
    --bg:#0b0e14;--panel:#0f1420;--stroke:#1c2436;--text:#e5e9f7;--muted:#a7b0c2;
    --chip:#12182a;--card:rgba(14,18,30,.96);--shadow:0 10px 30px rgba(0,0,0,.35);
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;}
  /* Layout */
  #app{display:grid;grid-template-columns:420px 1fr;min-height:100vh}
  @media (max-width: 900px){
    #app{grid-template-columns:1fr}
  }
  #sidebar{background:var(--panel);border-right:1px solid var(--stroke)}
  @media (max-width: 900px){ #sidebar{border-right:none;border-bottom:1px solid var(--stroke)} }
  #map{width:100%;height:calc(100vh - 56px)} /* mobile map takes rest of viewport */
  @media (min-width: 901px){ #map{height:100vh} }

  /* Header + toolbar */
  .header{position:sticky;top:0;background:var(--panel);z-index:5;
    display:flex;align-items:center;justify-content:space-between;gap:8px;
    padding:12px 14px;border-bottom:1px solid var(--stroke)}
  .title{font-size:18px;font-weight:650;margin:0}
  .sub{margin:0;font-size:12px;color:var(--muted)}
  .toolbar{display:flex;gap:8px;align-items:center;padding:10px 14px;border-bottom:1px solid var(--stroke)}
  .btn{cursor:pointer;background:#eef2ff;border:1px solid #dbe1fb;color:#0f172a;
    font-size:13px;padding:10px 12px;border-radius:12px;text-decoration:none}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:var(--shadow)}
  .btn.ghost{background:transparent;border-color:var(--stroke);color:var(--text)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  /* Controls */
  .section{padding:10px 14px;border-bottom:1px solid var(--stroke)}
  .h2{font-size:12px;letter-spacing:.10em;text-transform:uppercase;color:var(--muted);margin:0 0 8px}
  .search input{width:100%;padding:12px 14px;border:1px solid var(--stroke);border-radius:12px;background:#fff}
  .chips{display:flex;gap:8px;overflow:auto;padding:2px}
  .chip{white-space:nowrap;background:var(--chip);border:1px solid var(--stroke);
    padding:8px 12px;border-radius:999px;font-size:12px;display:inline-flex;gap:6px;align-items:center}
  .chip input{accent-color:var(--thu)}

  /* Cards */
  .list{padding:8px 8px 14px;display:grid;gap:8px}
  .card{background:var(--card);border:1px solid var(--stroke);border-radius:14px;padding:12px 12px;box-shadow:var(--shadow)}
  .card .row{display:flex;justify-content:space-between;gap:8px;align-items:start}
  .card .name{font-weight:650}
  .meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
  .pill{border:1px solid var(--stroke);background:#fff;border-radius:8px;font-size:11px;padding:3px 8px}
  .note{font-size:12px;color:var(--muted);margin-top:4px}
  .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .visited .name{text-decoration:line-through;opacity:.8}

  /* Form sheet (mobile friendly) */
  .sheet{position:fixed;left:0;right:0;bottom:-100vh;background:var(--panel);border-top:1px solid var(--stroke);
    box-shadow:0 -10px 30px rgba(0,0,0,.25);border-radius:16px 16px 0 0;transition:transform .25s ease;transform:translateY(100%);z-index:20}
  .sheet.open{transform:translateY(0);bottom:0}
  .sheet-head{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--stroke)}
  .sheet-body{padding:12px 14px;display:grid;gap:10px}
  .field{display:grid;gap:6px}
  .field label{font-size:12px;color:var(--muted)}
  .field input,.field select,.field textarea{padding:12px;border-radius:12px;border:1px solid var(--stroke);background:#fff}
  .inline-buttons{display:flex;gap:8px;flex-wrap:wrap}

  /* Legend + hotel marker styles */
  .legend{position:absolute;top:10px;right:10px;z-index:1000;background:rgba(255,255,255,.95);
    border:1px solid var(--stroke);border-radius:10px;padding:8px 10px;font-size:12px}
  .legend .item{display:flex;gap:6px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.thu{background:var(--thu)}.dot.fri{background:var(--fri)}.dot.sat{background:var(--sat)}.dot.sun{background:var(--sun)}.dot.hotel{background:var(--hotel)}

  .hotel-marker .hotel-icon{display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;
    background:var(--hotel);color:#fff;font-weight:700;border:2px solid rgba(255,255,255,.85);box-shadow:0 4px 12px rgba(0,0,0,.35)}
</style>
<script>
  (function(){try{const s=localStorage.getItem('rome_theme');if(s==='dark'){document.documentElement.dataset.theme='dark'}}catch(e){}})();
</script>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <div class="header">
      <div>
        <h1 class="title">Rome Planner</h1>
        <p class="sub">Realtime • Mobile-first</p>
      </div>
      <button class="btn ghost" id="btnTheme">Theme</button>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="btnCreate">Add place</button>
      <button class="btn" id="btnBuildRoute">Route</button>
      <button class="btn ghost" id="btnClearRoute">Clear</button>
    </div>

    <div class="section search">
      <div class="h2">Search</div>
      <input id="searchBox" placeholder="Find places…" />
    </div>

    <div class="section">
      <div class="h2">Filter days</div>
      <div class="chips">
        <label class="chip"><input type="checkbox" data-day="thu" checked /> Thu</label>
        <label class="chip"><input type="checkbox" data-day="fri" checked /> Fri</label>
        <label class="chip"><input type="checkbox" data-day="sat" checked /> Sat</label>
        <label class="chip"><input type="checkbox" data-day="sun" checked /> Sun</label>
      </div>
    </div>

    <div class="section">
      <div class="h2">Route endpoints</div>
      <div class="field">
        <label>Start</label>
        <select id="routeStart"><option value="">(Pick)</option></select>
      </div>
      <div class="field">
        <label>End</label>
        <select id="routeEnd"><option value="">(Pick)</option></select>
      </div>
      <p id="routeSummary" style="color:var(--muted);font-size:12px;margin:6px 0 0">Select start and end, then tap Route.</p>
    </div>

    <div class="list" id="list"></div>
  </aside>
  <div style="position:relative">
    <div id="map"></div>
    <div class="legend">
      <div class="item"><span class="dot hotel"></span> Hotel</div>
      <div class="item"><span class="dot thu"></span> Thu</div>
      <div class="item"><span class="dot fri"></span> Fri</div>
      <div class="item"><span class="dot sat"></span> Sat</div>
      <div class="item"><span class="dot sun"></span> Sun</div>
    </div>
  </div>
</div>

<!-- Sheet: Create/Edit (no lat/lng fields) -->
<div class="sheet" id="sheet">
  <div class="sheet-head">
    <strong id="sheetTitle">Add place</strong>
    <div>
      <button class="btn ghost" id="btnCancel">Cancel</button>
      <button class="btn primary" id="btnSave">Save</button>
    </div>
  </div>
  <div class="sheet-body">
    <div class="field"><label>Title</label><input id="fTitle" required /></div>
    <div class="field">
      <label>Day</label>
      <select id="fDay">
        <option value="thu">Thu</option><option value="fri">Fri</option><option value="sat">Sat</option><option value="sun">Sun</option>
      </select>
    </div>
    <div class="field"><label>Info URL (optional)</label><input id="fUrl" placeholder="https://…" /></div>
    <div class="field"><label>Tags (comma separated)</label><input id="fTags" placeholder="market, museum" /></div>
    <div class="field"><label>Note</label><textarea id="fNote" rows="2" placeholder="Optional note"></textarea></div>

    <div class="field">
      <label>Location</label>
      <input id="fLocation" placeholder="Paste Google Maps link or '41.9,12.49'" />
      <div class="inline-buttons">
        <button class="btn" id="btnPickOnMap" type="button">Pick on map</button>
        <button class="btn" id="btnUseMyLoc" type="button">Use my location</button>
      </div>
      <small id="locHint" style="color:var(--muted)"></small>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed;bottom:12px;left:12px;right:12px;z-index:30;display:none;
  background:#fff;border:1px solid var(--stroke);padding:10px 12px;border-radius:10px;box-shadow:var(--shadow);font-size:13px"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script type="module">
/*** CONFIG — replace with your Supabase project values ***/
const SUPABASE_URL = "https://YOURPROJECT.supabase.co";
const SUPABASE_ANON_KEY = "YOUR_PUBLIC_ANON_KEY";

/*** Imports ***/
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

/*** State ***/
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
window.supabase = supabase; // handy for console
const HOTEL = { id:'hotel-base', title:'Hotel Base', lat:41.91029, lng:12.45436, address:'Via Andrea Doria 79' };
const DAY_COLORS = { thu:'#6aa3ff', fri:'#f6b043', sat:'#62d3b1', sun:'#ff6a8a' };
const state = { places:[], routeSelection:new Set(), routeLine:null, currentRoute:null, editingId:null, pickMode:false, pickedLatLng:null };

const els = {
  theme: qs('#btnTheme'), create: qs('#btnCreate'), build: qs('#btnBuildRoute'), clear: qs('#btnClearRoute'),
  search: qs('#searchBox'), list: qs('#list'), routeStart: qs('#routeStart'), routeEnd: qs('#routeEnd'), routeSummary: qs('#routeSummary'),
  sheet: qs('#sheet'), sheetTitle: qs('#sheetTitle'), btnCancel: qs('#btnCancel'), btnSave: qs('#btnSave'),
  fTitle: qs('#fTitle'), fDay: qs('#fDay'), fUrl: qs('#fUrl'), fTags: qs('#fTags'), fNote: qs('#fNote'),
  fLocation: qs('#fLocation'), btnPickOnMap: qs('#btnPickOnMap'), btnUseMyLoc: qs('#btnUseMyLoc'), locHint: qs('#locHint'),
  toast: qs('#toast')
};

/*** Map ***/
const map = L.map('map',{scrollWheelZoom:true}).setView([41.9028,12.4964],13);
L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png',{maxZoom:20,subdomains:'abcd',
  attribution:'&copy; OpenStreetMap & CARTO'}).addTo(map);
let hotelMarker = L.marker([HOTEL.lat,HOTEL.lng],{icon:L.divIcon({className:'hotel-marker',html:'<span class="hotel-icon">H</span>',iconSize:[26,26],iconAnchor:[13,13]})}).addTo(map);
hotelMarker.bindPopup(`<b>${HOTEL.title}</b><br>${HOTEL.address}`);

/*** Helpers ***/
function qs(s){ return document.querySelector(s) }
function toast(m){ els.toast.textContent=m; els.toast.style.display='block'; setTimeout(()=>els.toast.style.display='none',1500) }
function uid(){ return Math.random().toString(36).slice(2,10) }
function dayColor(d){ return DAY_COLORS[d] || DAY_COLORS.thu }
function parseLatLngFromText(t){
  if(!t) return null;
  // 1) @lat,lng in URL
  let m = /@(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/.exec(t); if(m) return [parseFloat(m[1]),parseFloat(m[3])];
  // 2) q=lat,lng
  m = /[?&]q=(-?\d+(\.\d+)?),\s*(-?\d+(\.\d+)?)/.exec(t); if(m) return [parseFloat(m[1]),parseFloat(m[3])];
  // 3) ...!3dLAT!4dLNG
  m = /!3d(-?\d+(\.\d+)?)!4d(-?\d+(\.\d+)?)/.exec(t); if(m) return [parseFloat(m[1]),parseFloat(m[3])];
  // 4) any "lat,lng"
  m = /(-?\d+(\.\d+)?)\s*,\s*(-?\d+(\.\d+)?)/.exec(t); if(m) return [parseFloat(m[1]),parseFloat(m[3])];
  return null;
}

/*** DB IO ***/
function normalizeRow(r){ return { id:r.id, title:r.title, day:r.day, url:r.url||'', tags:Array.isArray(r.tags)?r.tags:(r.tags||[]), note:r.note||'', lat:+r.lat, lng:+r.lng, visited:!!r.visited } }
async function loadAll(){ const {data,error}=await supabase.from('places').select('*').order('created_at',{ascending:true}); if(error) throw error; return (data||[]).map(normalizeRow) }
async function insertPlace(p){ const {error}=await supabase.from('places').insert(p); if(error) throw error }
async function updatePlace(p){ const {error}=await supabase.from('places').update(p).eq('id',p.id); if(error) throw error }
async function deletePlace(id){ const {error}=await supabase.from('places').delete().eq('id',id); if(error) throw error }
async function setVisitedDB(id,v){ const {error}=await supabase.from('places').update({visited:!!v}).eq('id',id); if(error) throw error }

/*** Realtime ***/
supabase.channel('realtime:places')
  .on('postgres_changes', { event: '*', schema:'public', table:'places' }, payload => {
    const { eventType, new:rowNew, old:rowOld } = payload;
    if(eventType==='INSERT'){
      const p = normalizeRow(rowNew);
      if(!state.places.find(x=>x.id===p.id)) state.places.push(p);
    }else if(eventType==='UPDATE'){
      const p = normalizeRow(rowNew);
      const i = state.places.findIndex(x=>x.id===p.id);
      if(i>=0) state.places[i]=p; else state.places.push(p);
    }else if(eventType==='DELETE'){
      const id = rowOld?.id;
      state.places = state.places.filter(x=>x.id!==id);
      state.routeSelection.delete(id);
      if(els.routeStart.value===id) els.routeStart.value='';
      if(els.routeEnd.value===id) els.routeEnd.value='';
    }
    refresh();
    if(state.routeLine) rebuildRoute();
  })
  .subscribe();

/*** UI rendering ***/
const markersById = new Map();
function renderMarkers(){
  for(const m of markersById.values()) map.removeLayer(m);
  markersById.clear();
  const visible = visibleDays();
  for(const p of state.places){
    if(visible && !visible.has(p.day)) continue;
    const color = dayColor(p.day);
    const visited = p.visited;
    const inRoute = state.currentRoute?.has(p.id) || state.routeSelection.has(p.id) ||
                    els.routeStart.value===p.id || els.routeEnd.value===p.id;
    const m = L.circleMarker([p.lat,p.lng], {radius: inRoute?8:7, color, fillColor:color, fillOpacity: visited?0.35:0.9, weight: inRoute?3:2, opacity: visited?0.7:1, dashArray: visited?'3 4':null})
      .bindPopup(`<div style="min-width:220px"><b>${p.title}</b><br><small>${p.day.toUpperCase()}</small><br>
        <div style="margin-top:6px;display:flex;gap:8px;flex-wrap:wrap">
          <a href="https://www.google.com/maps?q=${p.lat},${p.lng}(${encodeURIComponent(p.title)})" target="_blank" rel="noopener">Maps</a>
          <a href="#" data-act="start" data-id="${p.id}">Set as start</a>
          <a href="#" data-act="end" data-id="${p.id}">Set as end</a>
        </div>
        <div style="color:#94a3b8;margin-top:6px;font-size:11px">${p.lat.toFixed(5)}, ${p.lng.toFixed(5)}</div>
      </div>`);
    m.on('popupopen', e=>{
      const el = e.popup.getElement();
      el.querySelectorAll('a[data-act]').forEach(a=>{
        a.addEventListener('click',(ev)=>{
          ev.preventDefault();
          if(a.dataset.act==='start'){ els.routeStart.value = p.id; }
          if(a.dataset.act==='end'){ els.routeEnd.value = p.id; }
          updateRouteOptions(); refresh();
        });
      });
    });
    m.addTo(map);
    markersById.set(p.id,m);
  }
  // fit (only on desktop or when no route)
  if(!state.routeLine){
    const group = L.featureGroup([...markersById.values(), hotelMarker]);
    if(group.getLayers().length) map.fitBounds(group.getBounds().pad(0.12));
  }
}
function visibleDays(){
  const checks=[...document.querySelectorAll('.chips input')];
  return new Set(checks.filter(c=>c.checked).map(c=>c.dataset.day));
}
function renderList(){
  els.list.innerHTML = '';
  const q = (els.search.value||'').toLowerCase().trim();
  const vis = visibleDays();
  const groups = {thu:[],fri:[],sat:[],sun:[]};
  for(const p of state.places){
    if(vis && !vis.has(p.day)) continue;
    if(q && !p.title.toLowerCase().includes(q)) continue;
    groups[p.day].push(p);
  }
  const order = ['thu','fri','sat','sun'];
  for(const day of order){
    for(const p of groups[day]){
      const card = document.createElement('div'); card.className='card'+(p.visited?' visited':'');
      const row = document.createElement('div'); row.className='row';
      const left = document.createElement('div');
      left.innerHTML = `<div class="name">${p.title}</div>
        <div class="meta"><span class="pill">${day.toUpperCase()}</span><span class="pill">${(p.tags||[]).join(', ')||'-'}</span></div>
        ${p.note?`<div class="note">${p.note}</div>`:''}`;
      const right = document.createElement('div');
      const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=p.visited; cb.title='Visited';
      cb.addEventListener('change',()=> setVisitedDB(p.id, cb.checked).catch(()=>toast('Failed')));
      right.appendChild(cb);
      row.append(left,right);
      const acts = document.createElement('div'); acts.className='actions';
      const bZoom=button('Zoom',()=>{ const m=markersById.get(p.id); if(m){ map.setView(m.getLatLng(),16); m.openPopup() } });
      const bRoute=button('Include',()=>{ toggleRouteSel(p.id); });
      const bEdit=button('Edit',()=>openSheet('edit',p));
      const bDel=button('Delete',()=>removePlace(p.id));
      acts.append(bZoom,bRoute,bEdit,bDel);
      card.append(row,acts);
      els.list.appendChild(card);
    }
  }
}
function button(label, fn){ const b=document.createElement('button'); b.className='btn'; b.textContent=label; b.onclick=fn; return b }
function updateRouteOptions(){
  const cacheStart = els.routeStart.value, cacheEnd = els.routeEnd.value;
  [els.routeStart,els.routeEnd].forEach(sel=>{
    sel.innerHTML = '<option value="">(Pick)</option>';
    // include hotel
    const optH = document.createElement('option'); optH.value=HOTEL.id; optH.textContent='Hotel Base'; sel.appendChild(optH);
    for(const p of state.places){ const o=document.createElement('option'); o.value=p.id; o.textContent=p.title; sel.appendChild(o); }
  });
  els.routeStart.value = cacheStart || HOTEL.id;
  els.routeEnd.value = cacheEnd || '';
}

/*** Route ***/
function distanceKm(a,b){ const R=6371, dLat=(b.lat-a.lat)*Math.PI/180, dLng=(b.lng-a.lng)*Math.PI/180, lat1=a.lat*Math.PI/180, lat2=b.lat*Math.PI/180; const sL=Math.sin(dLat/2), sG=Math.sin(dLng/2); const h=sL*sL+Math.cos(lat1)*Math.cos(lat2)*sG*sG; return 2*R*Math.atan2(Math.sqrt(h),Math.sqrt(1-h)) }
function computeRoute(startId,endId, mids){
  const route=[startId]; let cur=startId; const rem=new Set(mids);
  while(rem.size){ const a=find(cur); if(!a) break; let best=null,bestD=Infinity;
    for(const id of rem){ const b=find(id); if(!b) continue; const d=distanceKm(a,b); if(d<bestD){bestD=d;best=id} }
    if(!best) break; route.push(best); rem.delete(best); cur=best;
  }
  if(route[route.length-1]!==endId) route.push(endId);
  return route;
}
function find(id){ if(id===HOTEL.id) return HOTEL; return state.places.find(p=>p.id===id) }
async function buildRoute(){
  const s=els.routeStart.value, e=els.routeEnd.value;
  if(!s || !e){ toast('Pick start and end'); return }
  const mids=[...state.routeSelection].filter(x=>x!==s && x!==e && find(x));
  const order = computeRoute(s,e,mids);
  const coords = order.map(id=>{ const p=find(id); return p?[p.lat,p.lng]:null }).filter(Boolean);
  if(coords.length<2){ toast('Need 2+ points'); return }
  // Try OSRM, fallback to straight polyline
  let geometry=coords, fallback=false, distanceMeters=0;
  try{
    const qs = coords.map(([lat,lng])=>`${lng.toFixed(6)},${lat.toFixed(6)}`).join(';');
    const url = `https://router.project-osrm.org/route/v1/foot/${qs}?overview=full&geometries=geojson`;
    const r = await fetch(url); if(!r.ok) throw 0;
    const j = await r.json();
    const g = j?.routes?.[0]?.geometry?.coordinates?.map(([lng,lat])=>[lat,lng]);
    if(g?.length>1){ geometry=g; distanceMeters = j.routes[0].distance||0; }
  }catch{ fallback=true; }
  if(state.routeLine){ map.removeLayer(state.routeLine) }
  state.routeLine = L.polyline(geometry,{color:'#ff6a8a',weight:4,opacity:.9}).addTo(map);
  map.fitBounds(state.routeLine.getBounds().pad(0.12));
  state.currentRoute = new Set(order);
  const km = distanceMeters ? (distanceMeters/1000).toFixed(1) : approxDistanceKm(geometry).toFixed(1);
  els.routeSummary.textContent = `${order.length} stops · ${km} km${fallback?' (approx.)':''}`;
  refresh();
}
function approxDistanceKm(geometry){
  let tot=0; for(let i=1;i<geometry.length;i++){ const a={lat:geometry[i-1][0],lng:geometry[i-1][1]}, b={lat:geometry[i][0],lng:geometry[i][1]}; tot+=distanceKm(a,b) }
  return tot;
}
function clearRoute(){ if(state.routeLine){ map.removeLayer(state.routeLine); state.routeLine=null; state.currentRoute=null; } els.routeSummary.textContent='Select start and end, then tap Route.'; refresh(); }
function toggleRouteSel(id){ if(state.routeSelection.has(id)) state.routeSelection.delete(id); else state.routeSelection.add(id); refresh(); }
function rebuildRoute(){ if(state.routeLine) buildRoute().catch(()=>clearRoute()) }

/*** Events ***/
els.theme.addEventListener('click',()=>{ const d=document.documentElement.dataset.theme; document.documentElement.dataset.theme = d==='dark'?'':'dark' });
els.create.addEventListener('click',()=>openSheet('create'));
els.btnCancel.addEventListener('click',closeSheet);
els.btnSave.addEventListener('click',saveSheet);
els.search.addEventListener('input',refresh);
document.querySelectorAll('.chips input').forEach(i=> i.addEventListener('change',refresh));
els.build.addEventListener('click',buildRoute);
els.clear.addEventListener('click',clearRoute);
els.routeStart.addEventListener('change',()=>{ if(state.routeLine) rebuildRoute(); else refresh(); });
els.routeEnd.addEventListener('change',()=>{ if(state.routeLine) rebuildRoute(); else refresh(); });

/*** Sheet (no lat/lng fields) ***/
let pickMarker = null;
function openSheet(mode='create', p=null){
  state.editingId = mode==='edit' && p ? p.id : null;
  els.sheetTitle.textContent = state.editingId ? 'Edit place' : 'Add place';
  els.fTitle.value = p?.title || '';
  els.fDay.value = p?.day || 'thu';
  els.fUrl.value = p?.url || '';
  els.fTags.value = (p?.tags||[]).join(', ');
  els.fNote.value = p?.note || '';
  els.fLocation.value = p ? `${p.lat},${p.lng}` : '';
  els.locHint.textContent = 'Paste a Google Maps link, type "lat,lng", tap Pick on map, or Use my location.';
  state.pickedLatLng = p ? [p.lat, p.lng] : null;
  state.pickMode = false;
  if(pickMarker){ map.removeLayer(pickMarker); pickMarker=null; }
  els.sheet.classList.add('open');
  // small mobile scroll into view
  setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}), 50);
}
function closeSheet(){ els.sheet.classList.remove('open'); state.pickMode=false; if(pickMarker){ map.removeLayer(pickMarker); pickMarker=null; } }

els.btnPickOnMap.addEventListener('click',()=>{
  state.pickMode = true;
  els.locHint.textContent = 'Pick mode: tap anywhere on the map to set location.';
  toast('Tap on the map to set point');
});
map.on('click', (e)=>{
  if(!state.pickMode) return;
  const {lat,lng} = e.latlng;
  state.pickedLatLng = [lat,lng];
  els.fLocation.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
  if(pickMarker){ map.removeLayer(pickMarker) }
  pickMarker = L.marker([lat,lng]).addTo(map);
  toast('Location selected');
  state.pickMode = false;
  els.locHint.textContent = 'Location set from map.';
});

els.btnUseMyLoc.addEventListener('click',()=>{
  if(!navigator.geolocation){ toast('Geolocation not available'); return }
  navigator.geolocation.getCurrentPosition(pos=>{
    const {latitude, longitude} = pos.coords;
    state.pickedLatLng = [latitude, longitude];
    els.fLocation.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
    if(pickMarker){ map.removeLayer(pickMarker) }
    pickMarker = L.marker([latitude,longitude]).addTo(map);
    map.setView([latitude,longitude],16);
    els.locHint.textContent = 'Location set from device.';
  }, ()=>toast('Could not get location'), { enableHighAccuracy:true, timeout:7000 });
});

async function saveSheet(){
  const title = els.fTitle.value.trim();
  if(!title){ toast('Title required'); return }
  // Derive lat/lng
  let latlng = state.pickedLatLng;
  if(!latlng && els.fLocation.value){
    const parsed = parseLatLngFromText(els.fLocation.value.trim());
    if(parsed) latlng = parsed;
  }
  if(!latlng){ toast('Please set location (paste link, pick on map, or use my location)'); return }
  const [lat,lng] = latlng;
  const tags = els.fTags.value.split(',').map(s=>s.trim()).filter(Boolean);
  const payload = {
    id: state.editingId || uid(),
    title,
    day: els.fDay.value,
    url: els.fUrl.value.trim() || null,
    tags,
    note: els.fNote.value.trim() || null,
    lat, lng,
    visited: false
  };
  try{
    if(state.editingId){
      const existing = state.places.find(x=>x.id===state.editingId);
      payload.visited = existing ? !!existing.visited : false;
      await updatePlace(payload);
      toast('Updated');
    }else{
      await insertPlace(payload);
      toast('Added');
    }
    closeSheet();
  }catch(e){ console.error(e); toast('Save failed'); }
}

async function removePlace(id){
  if(!confirm('Delete this place?')) return;
  try{ await deletePlace(id); toast('Deleted'); } catch(e){ toast('Delete failed') }
}

/*** Refresh ***/
function refresh(){ updateRouteOptions(); renderMarkers(); renderList(); }

/*** Boot ***/
(async function boot(){
  try{
    state.places = await loadAll();
    refresh();
  }catch(e){ console.error(e); toast('Failed to load data') }
})();
</script>
</body>
</html>
